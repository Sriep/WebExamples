<p>Auto scripts for building and deployment are an important part of software development. In the next couple of posts, I will look at creating simple Windows auto build and deploy batch files for applications developed using Qt Creator with GitHub for source control.&nbsp;</p>
<p>In this tutorial, I will use the&nbsp;<a href="https://doc.qt.io/qt-5/qtlocation-minimal-map-example.html">Qt minimal_map example</a>.&nbsp;which I have put on a GitHub site. The project can be cloned from&nbsp;<a href="https://github.com/Sriep/WebExamples.git">https://github.com/Sriep/WebExamples.git</a> and is then found in the minimal_map directory.</p>
<h2>Download and run project</h2>
<p>The basic rule on building Qt Creator projects on the command line is that all the required commands are documented&nbsp;on the Project tab.</p>
<p>Select a folder and run from the command line</p>
<blockquote>
<p><em><span style="color: #00ff00;">git clone&nbsp;<a href="https://github.com/Sriep/WebExamples.git">https://github.com/Sriep/WebExamples.git</a></span></em></p>
</blockquote>
<p>Open Qt Creator and open the&nbsp;<span class="css-truncate css-truncate-target"><a id="7a40da7ae44f06ab926427dbabf076f8-5210809fb1ef5968f2e94ec64e750401951e8401" class="js-navigation-open" title="minimal_map" href="https://github.com/Sriep/WebExamples/tree/master/minimal_map">minimal_map</a>/</span><em>minimal_map.pro&nbsp;project</em>&nbsp;file. This is the Qt minimal map example that I have copied into a GitHub directory.</p>
<p>In Qt Creator select the Project tab in the left-hand tab panel. Make sure that you are using a Windows Kit, something like "Desktop Qt 5.9.0 MSVC2015 64bit". Build the project and confirm you get something like Figure 1.&nbsp;</p>
<h2>Build from command line</h2>
<p>The rule of thumb for building Qt Creator projects on the command line is to use the code in the Project tab,&nbsp;Build settings&nbsp;page. Figure 2.</p>
<p>Copying the commands from the Build Steps, Clean Steps sections of the project Build Settings page we get something like. The paths will probably be slightly different for you.</p>
<blockquote>
<p><span style="color: #00ff00;">qmake.exe E:\Examples\WebExamples\minimal_map\minimal_map.pro -spec win32-msvc "CONFIG+=debug" "CONFIG+=qml_debug" &amp;&amp; C:/Qt/Tools/QtCreator/bin/jom.exe qmake_all</span></p>
<p><span style="color: #00ff00;">jom.exe in E:\Examples\WebExamples\build-minimal_map-Desktop_Qt_5_9_0_MSVC2015_64bit_qt_59_w-Debug</span></p>
<p><span style="color: #00ff00;">jom.exe clean in E:\Examples\WebExamples\build-minimal_map-Desktop_Qt_5_9_0_MSVC2015_64bit_qt_59_w-Debug</span></p>
</blockquote>
<p>Try running the first qmake.exe command.</p>
<p>What goes wrong?</p>
<h3>Add Qt directory to PATH</h3>
<p>The first thing that could go wrong is that&nbsp;qmake.exe won't be recognised. This should be an easy&nbsp;problem&nbsp;to fix. You either need to add the directory where qmake.exe is to your PATH environmental variable, or you need to fully path the qmake.exe command.</p>
<p>Which qmake.exe am I using?&nbsp;</p>
<p>Browser to your Qt directory. For me its&nbsp;C:\Qt\5.9\msvc2015. You should see something like figure 3. There are a lot of different Qt Versions, all with their own bin directories and qmake.exe s. To find the one we need requires a little "paper chase".&nbsp;</p>
<ol>
<li>Go to the Project tab. Note the selected Qt version in the Build &amp; Run section of the left-hand panel. For me its "Desktop Qt 5.9.0 MSVC201564bit" figure 2.</li>
<li>Menu: Tools/Options. Build &amp; Run tab, Kits tab. Select the Qt version from (1) in the list. Probably in the Auto-detected section.&nbsp;</li>
<li>Lots of information should appear about your Qt version. Note the entry in the Qt version row. For me, it's "Qt 5.9.0 MSVC2015 64bit" figure 3.</li>
<li>Now go to the Qt Versions tab and select the Qt version from (3).</li>
<li>The "qmake location" field at the bottom of the page should now be populated with the qmake you want. For me it was "C:\Qt\5.9\msvc2015_64\bin\qmake.exe"</li>
</ol>
<p>Remember that some versions of QtCreator might have stuff set up slightly differently. For instance, the Options panel might be located on the Tools menu. Don't panic just look around for it.</p>
<p>So run the following on the command line. Where instead of&nbsp;C:\Qt\5.9\msvc2015_64 enter whatever qmake path you found on your QtVersion.</p>
<blockquote>
<p><span style="color: #00ff00;">set QT_DIR=C:\Qt\5.9\msvc2015_64</span></p>
<p><span style="color: #00ff00;"><br />set PATH=%QT_DIR%\bin;%PATH%</span></p>
</blockquote>
<p>You should set the Qt bin directory at the head of your PATH, even if qmake.exe is being found. You cannot necessarily be sure the default qmake.exe is the right one.</p>
<p>Now rerun the qmke command. qmake should now be found and you should get a new error.</p>
<h3>QMAKE_MSC_VER isn't set</h3>
<p>You should all now be getting some error complaining about envoirmental variable snot being set. For me the error message is&nbsp;</p>
<blockquote>
<p><span style="color: #ff0000;">Info: creating stash file E:\Examples\WebExamples\minimal_map\.qmake.stash</span></p>
<p><span style="color: #ff0000;">C:/Qt/5.9/msvc2015_64/mkspecs/features/toolchain.prf:129: Variable QMAKE_CXX.COMPILER_MACROS is not defined.</span></p>
<p><span style="color: #ff0000;">Project ERROR: msvc-version.conf loaded but QMAKE_MSC_VER isn't set</span></p>
</blockquote>
<p>At this point, there is the danger of jumping down a rabbit hole. &nbsp;QMAKE_MSC_VER is not set, lets set it, what's our MSC_VER. Add a command to set it, rerun qmake and get another error. 'Fix' that one, get another, and so on.&nbsp;</p>
<p>NO! NO! &nbsp;</p>
<p>To see what is missing we need to revisit our paper chase from the last section. We need to inspect the compilers panel.</p>
<ol>
<li>Go to the Project tab. Note the selected Qt version in the Build &amp; Run section of the left-hand panel. For me its "Desktop Qt 5.9.0 MSVC201564bit" figure 2.</li>
<li>Menu: Tools/Options. Build &amp; Run tab, Kits tab. Select the Qt version from (1) in the list. Probably in the Auto-detected section.&nbsp;</li>
<li>Lots of information should appear about your Qt version.<strong> Note the entry in the Compiler C++ row.</strong> For me, it's "Microsoft Visual C++ Compiler 14.0 (amd64)" figure 3.</li>
<li>Visit the compilers tab. Select the row corresponding to the C++ compiler in (3).</li>
<li>A row titled "Initialization" should appear with a command to run a .bat file. For me, the command was "C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\vcvarsall.bat amd64". Figure 5.</li>
</ol>
<p>What (5) is saying is that before we can run qmake.exe we need to run the indicated .bat file. This will set&nbsp;QMAKE_MSC_VER and the other environmental variables we will need.</p>
<p>So no try running the batch file. But note there are likely spaces in the path, so you will probably need to put quotes around the path.</p>
<blockquote>
<p><span style="color: #00ff00;">"C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\"vcvarsall.bat amd64</span></p>
</blockquote>
<p>Row try running the qmake&nbsp;command. If all is well you should see something like.</p>
<p><span style="color: #0000ff;">jom 1.1.2 - empower your cores</span></p>
<h3>Build using jom.exe</h3>
<p><a href="http://wiki.qt.io/Jom">jom is a clone of nmake</a>. In Qt Creator jom is used with the path to the output file as an argument. For reasons that will be clear later we will compile in the default location, which is in a subdirectory of the project source directory.&nbsp;</p>
<p>jom.exe is part of Qt Creator. So you should probably&nbsp;add that to the path the same way as we added the qmake directory.&nbsp;C:\Qt\Tools\QtCreator\bin is where my Qt Creator is located, replace this with wherever your Qt Creator is located. No run.</p>
<blockquote>
<p><span style="color: #00ff00;">set PATH=C:\Qt\Tools\QtCreator\bin;%PATH%</span></p>
<p><span style="color: #00ff00;">jom.exe </span></p>
<p><span style="color: #00ff00;">jom.exe clean</span></p>
</blockquote>
<p>jom.exe will build the project. jom.exe clean will remove unwanted files. You will find the result in the release directory of our minimal_map source directory.&nbsp;</p>
<h2>Recap -&nbsp;buildWin_minimal_map1.bat</h2>
<p>So using what we have learnt so far we want to set up a batch file to:</p>
<ol>
<li>Set up environmental variables. Some of these could be converted into parameters.</li>
<li>Download source from GitHub into new build directory. Make sure any previous directories have been deleted.</li>
<li>Run the initialise script. Remember to use 'call' to run a .bat file within another .bat file.&nbsp;</li>
<li>Run the commands from QtCreator Build Settings.</li>
</ol>
<p>Change the BUILD_DIR, QT_DIR and QT_CREATERDIR in buildWin_minimal_map1.bat to match your system then run it. I have made the convention of naming the Project, project directory, executable and .pro file with the same label "minimal_map". This is generally good practice, as, as well as reducing confusion it allows the use of generic batch files like this one.</p>
<blockquote>
<p><em>REM Batch file for auto build</em></p>
<p><em>REM Set project identity variables</em><br /><em>set PROJECTNAME=minimal_map</em><br /><em>set GITHUB_URL=https://github.com/Sriep/WebExamples.git</em><br /><em>set BUILD_DIR=C:\Data\Build_%PROJECTNAME%</em></p>
<p><em>REM Set executable locations</em><br /><em>set QT_DIR=C:\Qt\5.9\msvc2015_64</em><br /><em>set QT_CREATORDIR=C:\Qt\Tools\QtCreator</em></p>
<p><em>REM Set internal variables</em><br /><em>set SRCDIR=%BUILD_DIR%\WebExamples\%PROJECTNAME%</em><br /><em>set PATH=%QT_DIR%\bin;%QT_CREATOR_DIR%/bin;%PATH%</em></p>
<p><em>REM Setup build directory</em><br />mkdir<em> %BUILD_DIR%</em><br /><em>cd %BUILD_DIR%</em></p>
<p><em>REM Download from GitHub</em><br /><em>git clone %GITHUB_URL%</em></p>
<p><em>REM Initialise builds</em><br /><em>call C:\"Program Files (x86)\Microsoft Visual Studio 14.0\VC"\vcvarsall.bat amd64</em></p>
<p><em>REM Build project</em><br /><em>cd %SRCDIR%</em><br /><em>qmake.exe %SRCDIR%\%PROJECTNAME%.pro -spec win32-msvc "CONFIG+=qtquickcompiler" &amp;&amp; jom.exe qmake_all</em><br /><em>jom.exe </em><br /><em>jom.exe clean</em></p>
</blockquote>
<p>If you have problems running the whole file run each line in turn. Make sure the build directrory is empty. It is also best to do everything on one dirve, e.g.&nbsp;don't mix c: and d: paths. Make sure the&nbsp;BUILD_DIR, QT_DIR and QT_CREATERDIR variables match your system.</p>
<h2>Provide Qt system files&nbsp;</h2>
<p>You should now have a copy of &nbsp;minimal_map.exe at&nbsp;%BUILD_DIR%\WebExamples\%PROJECTNAME%\release\minimal_map.exe.</p>
<p>Now try running the file. E.g. double click in windows file explorer. You should get an error message about missing files similar to figure 6. Astute readers would have expected this, as we are missing .dll and other Qt files that our programme needs to run.&nbsp;</p>
<p>Sometimes where we do this sort of test the executable will run despite missing the required files. This means the operating system has managed to find some matching files somewhere. This is bad and is why it is advisable to do deployment tests on a machine without Qt installed, or if that is too inconvinet as here, just temporarily rename the Qt directory.&nbsp;</p>
<p>Ok, so we now need to find the files our&nbsp;minimal_map.exe needs. So a bit of theory here. More details plus some nice figures can be found at&nbsp;<a href="https://wiki.qt.io/Deploy_an_Application_on_Windows">https://wiki.qt.io/Deploy_an_Application_on_Windows</a></p>
<h3>Maximal solution&nbsp;</h3>
<p>The brute force method is to copy every Qt file into the same folder as our lone&nbsp;minimal_map.exe. As explained in&nbsp;<a href="https://wiki.qt.io/Deploy_an_Application_on_Windows">https://wiki.qt.io/Deploy_an_Application_on_Windows</a>&nbsp;the&nbsp;%QT_DIR%/bin,&nbsp;%QT_DIR%/plugin and&nbsp;%QT_DIR%/qml directories should be enough.</p>
<p>So that works, but the big problem is that our build is now nearly 5GB. This is really far too large for a final release. However, this acts as a useful&nbsp;sanity check.</p>
<p>If our maximal build works we know that we just need to add the right files to complete our build. While if it does not work, we know that the problem is elsewhere and maybe our project is not ready for deployment.</p>
<h3>windeployqt.exe</h3>
<p>The Windows deployment tool, windeployqt.exe, is a useful tool that takes an executable, and copies over the Qt files needed to support running the executable.&nbsp;</p>
<p>The tool works fairly well. It copies most files over but sometimes will miss some. We will see that when we look at the&nbsp;simpletextviewer&nbsp;project later.&nbsp;</p>
<p>You can read more about windepolyqt.exe at <a href="http://doc.qt.io/qt-5/windows-deployment.html">http://doc.qt.io/qt-5/windows-deployment.html</a>. We will be running&nbsp;windepolyqt.exe with two arguments, the qml source directory and the path to our&nbsp;minimal_map.exe file.</p>
<p>windepolyqt.exe&nbsp;--qmldir&nbsp;[qml source directory] [our.exe]</p>
<p>We can now add four more lines to our batch file</p>
<blockquote>
<p>REM Build release<br />set WINDEPLOYQT_EXE=%QT_DIR%\bin\windeployqt.exe<br />set RELEASE_DIR=%SRCDIR%\release<br />set QML_DIR=%SRCDIR%<br />%WINDEPLOYQT_EXE% --qmldir %QML_DIR% %RELEASE_DIR%\%PROJECTNAME%.exe</p>
</blockquote>
<p>Delete your build directory, and try running buildWin_minimal_map2.bat. &nbsp;Now find the release directory and run&nbsp;minimal_map.exe; this time it should run smoothly.</p>
<h2>Installer&nbsp;</h2>
<p>For this post, I will be using&nbsp;<a href="http://www.jrsoftware.org/isinfo.php">Inno Setup&nbsp;</a>to create our installer. You can install from&nbsp;http://www.jrsoftware.org/isdl.php.</p>
<p>To set up the installer you create a .iss file which gives the configuration details for your installation. Then run the executable iscc.exe using the .iss file as input. You can use the Compil32.exe to start a script wizard to create a custom .iss file.</p>
<p>minimal_map\deploy\minimal_map.iss contains an example .iss file for the&nbsp;minimal_map.exe project. To run it we add the following lines to the end of our batch file. Change the set&nbsp;INNO_DIR command to match wherever you have installed Inno Setup.</p>
<blockquote>
<p>REM Create install file<br />set INNO_DIR="C:\Program Files (x86)\Inno Setup 5"<br />cd %INNO_DIR%<br />iscc /Q %SRCDIR%\deploy\%PROJECTNAME%.iss</p>
</blockquote>
<p>Delete the current BUILD_DIR% directory and run&nbsp;buildWin_minimal_map_final.bat. In the&nbsp;WebExamples\minimal_map\deploy\Output\minimal_mapSetup.exe directory, you should find the installer.</p>
<h3>Configure .iss file</h3>
<p>All the paths in the .iss file are relative to the position of the .iss file. So for instance line 40&nbsp;</p>
<blockquote>
<p>[Files]<br />Source: ..\release\*; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs</p>
</blockquote>
<p>We indicate the files to include in the installer as ..\release\*. This is why we used the default settings when we run jom.exe so that we can easily reference the files in %BUILD_DIR%\WebExamples\minimal_map\release to be included in the installation.</p>
<p>Lines 24-26</p>
<blockquote>
<p>LicenseFile=LicenseFileWin.txt<br />InfoBeforeFile=InfoBeforeWin.txt<br />InfoAfterFile=InfoAfterWin.txt</p>
</blockquote>
<p>These files give the text that is displayed during installation. Feel free to edit.</p>